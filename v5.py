# V4 - transformando arquivo parquet para csv
import streamlit as st
from openai import OpenAI
import httpx
import pandas as pd
import os
from dotenv import load_dotenv

load_dotenv()

api_key = os.getenv("API_KEY")
 
st.set_page_config(page_title="An√°lise de Inadimpl√™ncia", page_icon="üíº")

@st.cache_resource
def get_openai_client():
    return OpenAI(
        api_key=api_key,
        base_url="https://api.deepseek.com", 
        http_client=httpx.Client(verify=False)
    )

@st.cache_data
def load_data():
    return pd.read_csv(
        r"C:\Users\AT154GY\OneDrive - EY\Desktop\IA Inadimplencia\df_cons_agg.csv"
    ) 

def generate_base_insights(df):
    # print("Tipos de dados originais:")
    # print(df.dtypes)

    numeric_columns = [
        'carteira_inadimplida_arrastada', 
        'carteira_ativa', 
        'a_vencer_ate_90_dias', 
        'ativo_problematico', 
        'numero_de_operacoes'
    ]

    for col in numeric_columns:
        # Tente m√∫ltiplas estrat√©gias de convers√£o
        df[col] = pd.to_numeric(
            df[col].astype(str).str.replace(',', '.').str.replace('R$', '').str.replace(' ', ''), 
            errors='coerce'
        ).fillna(0)

    # Adicione verifica√ß√£o de valores ap√≥s convers√£o
    # print("\nValores ap√≥s convers√£o:")
    # for col in numeric_columns:
    #     print(f"{col} - Soma: {df[col].sum()}, Tipo: {df[col].dtype}")


    # Preparar dados
    df['regiao'] = df['uf'].map({
        'AC': 'Norte', 'AM': 'Norte', 'AP': 'Norte', 'PA': 'Norte', 'RO': 'Norte', 'RR': 'Norte', 'TO': 'Norte',
        'AL': 'Nordeste', 'BA': 'Nordeste', 'CE': 'Nordeste', 'MA': 'Nordeste', 'PB': 'Nordeste', 'PE': 'Nordeste', 'PI': 'Nordeste', 'RN': 'Nordeste', 'SE': 'Nordeste',
        'GO': 'Centro-Oeste', 'MT': 'Centro-Oeste', 'MS': 'Centro-Oeste', 'DF': 'Centro-Oeste',
        'SP': 'Sudeste', 'RJ': 'Sudeste', 'MG': 'Sudeste', 'ES': 'Sudeste',
        'PR': 'Sul', 'RS': 'Sul', 'SC': 'Sul'
    })
    
    # Preparar insights detalhados
    insights = "Contexto Abrangente de Inadimpl√™ncia:\n\n"
    
    # Filtrar por estado e somar a inadimpl√™ncia
    inadimplencia_por_estado = df.groupby('uf')['carteira_inadimplida_arrastada'].sum()

    # Adicionar ao contexto de insights
    insights += "\nTotal inadimplente por estado:\n"
    for estado, valor in inadimplencia_por_estado.items():
        insights += f"- {estado}: R$ {valor:,.2f}\n"

    # 1. Mapa de Regi√£o e Inadimpl√™ncia
    regiao_inadimplencia = df.groupby('regiao')['carteira_inadimplida_arrastada'].sum().sort_values(ascending=False)
    insights += "1. Panorama Regional de Inadimpl√™ncia:\n"
    for regiao, valor in regiao_inadimplencia.items():
        percentual = (valor / df['carteira_inadimplida_arrastada'].sum()) * 100
        insights += f"- {regiao}: R$ {valor:,.2f} ({percentual:.2f}% da inadimpl√™ncia total)\n"
    
    # 2. Inadimpl√™ncia por CNAE
    cnae_inadimplencia = df.groupby('cnae_secao')['carteira_inadimplida_arrastada'].sum().sort_values(ascending=False)
    insights += "\n2. Setores Econ√¥micos e Inadimpl√™ncia:\n"
    for cnae, valor in cnae_inadimplencia.head(5).items():
        percentual = (valor / df['carteira_inadimplida_arrastada'].sum()) * 100
        insights += f"- {cnae}: R$ {valor:,.2f} ({percentual:.2f}% da inadimpl√™ncia)\n"
    
    # 3. Comparativo PF vs PJ
    df['tipo_cliente'] = df['cliente'].apply(lambda x: 'PF' if 'F√≠sica' in str(x) else 'PJ')
    cliente_inadimplencia = df.groupby('tipo_cliente')['carteira_inadimplida_arrastada'].agg(['sum', 'mean'])
    insights += "\n3. Comparativo Pessoa F√≠sica vs Pessoa Jur√≠dica:\n"
    for tipo, dados in cliente_inadimplencia.iterrows():
        insights += f"- {tipo}: Total R$ {dados['sum']:,.2f}, M√©dia R$ {dados['mean']:,.2f}\n"
    
    # 4. Modalidades por Tipo de Cliente
    modalidade_cliente_inadimplencia = df.groupby(['tipo_cliente', 'modalidade'])['carteira_inadimplida_arrastada'].sum()
    insights += "\n4. Modalidades de Inadimpl√™ncia:\n"
    for (tipo, modalidade), valor in modalidade_cliente_inadimplencia.sort_values(ascending=False).head(6).items():
        insights += f"- {tipo} - {modalidade}: R$ {valor:,.2f}\n"
    
    # 5. Porte do Cliente
    porte_inadimplencia = df.groupby(['tipo_cliente', 'porte'])['carteira_inadimplida_arrastada'].sum()
    insights += "\n5. Inadimpl√™ncia por Porte de Empresa:\n"
    for (tipo, porte), valor in porte_inadimplencia.sort_values(ascending=False).head(6).items():
        insights += f"- {tipo} - {porte}: R$ {valor:,.2f}\n"
    
    # 6. Previs√£o de Inadimpl√™ncia em 90 dias
    df['previsao_inadimplencia_90d'] = df['a_vencer_ate_90_dias'] * (df['carteira_inadimplida_arrastada'] / df['carteira_ativa'])
    previsao_porte = df.groupby('porte')['previsao_inadimplencia_90d'].mean()
    insights += "\n6. Previs√£o de Inadimpl√™ncia em 90 dias por Porte:\n"
    for porte, previsao in previsao_porte.items():
        insights += f"- {porte}: R$ {previsao:,.2f}\n"
    
    # 7. Crescimento de Opera√ß√µes Inadimplentes
    anos_operacoes = df.groupby('data_base').agg({
        'numero_de_operacoes': 'sum',
        'carteira_inadimplida_arrastada': 'sum'
    })
    insights += "\n7. Evolu√ß√£o de Opera√ß√µes Inadimplentes:\n"
    for ano, dados in anos_operacoes.iterrows():
        insights += f"- {ano}: {dados['numero_de_operacoes']} opera√ß√µes, R$ {dados['carteira_inadimplida_arrastada']:,.2f} inadimplidos\n"
    
    # 8. Inadimpl√™ncia por Ocupa√ß√£o
    ocupacao_inadimplencia = df[df['tipo_cliente'] == 'PF'].groupby('ocupacao')['carteira_inadimplida_arrastada'].sum()
    insights += "\n8. Inadimpl√™ncia por Ocupa√ß√£o (Pessoa F√≠sica):\n"
    for ocupacao, valor in ocupacao_inadimplencia.sort_values(ascending=False).head(5).items():
        insights += f"- {ocupacao}: R$ {valor:,.2f}\n"
    
    # 9. Proje√ß√£o de Inadimpl√™ncia Futura
    insights += "\n9. Proje√ß√£o Estrat√©gica de Inadimpl√™ncia:\n"
    insights += "- An√°lise detalhada requer modelagem estat√≠stica avan√ßada\n"
    insights += "- Fatores-chave: porte do cliente, setor econ√¥mico, comportamento hist√≥rico\n"
    
    # 10. Indicador de Reestrutura√ß√£o
    df['indicador_reestruturacao'] = df['ativo_problematico'] - df['carteira_inadimplida_arrastada']
    reestruturacao_analise = df.groupby('porte')['indicador_reestruturacao'].mean()
    insights += "\n10. An√°lise de Reestrutura√ß√£o:\n"
    for porte, indicador in reestruturacao_analise.items():
        insights += f"- {porte}: Indicador m√©dio R$ {indicador:,.2f}\n"
    
    # Temas Adicionais de um Especialista em Inadimpl√™ncia
    insights += "\n11. An√°lises Estrat√©gicas Adicionais:\n"
    insights += "- Correla√ß√£o entre modalidade de cr√©dito e risco de inadimpl√™ncia\n"
    insights += "- Impacto de ciclos econ√¥micos no comportamento de pagamento\n"
    insights += "- Segmenta√ß√£o de clientes por perfil de risco\n"
    insights += "- Estrat√©gias de mitiga√ß√£o de inadimpl√™ncia\n"
    
    # Contextualiza√ß√£o Final
    insights += "\nNOTA IMPORTANTE:\n"
    insights += "- Estes insights s√£o baseados em an√°lise estat√≠stica descritiva\n"
    insights += "- Recomenda-se an√°lise aprofundada para decis√µes estrat√©gicas\n"
    insights += "- Vari√°veis externas podem impactar significativamente as proje√ß√µes\n"
    
    # An√°lises Adicionais
    insights += "\n12. An√°lises Complementares:\n"
    
    # Estado mais Inadimplente
    estado_inadimplencia = df.groupby('uf')['carteira_inadimplida_arrastada'].agg(['sum', 'mean']).sort_values('sum', ascending=False)
    top_estado_inadimplente = estado_inadimplencia.head(3)
    insights += "Estados com Maior Inadimpl√™ncia:\n"
    for estado, dados in top_estado_inadimplente.iterrows():
        percentual = (dados['sum'] / df['carteira_inadimplida_arrastada'].sum()) * 100
        insights += f"- {estado}: R$ {dados['sum']:,.2f} ({percentual:.2f}% da inadimpl√™ncia total), M√©dia por registro: R$ {dados['mean']:,.2f}\n"
    
    # An√°lise de Concentra√ß√£o de Inadimpl√™ncia
    insights += "\nConcentra√ß√£o de Inadimpl√™ncia:\n"
    # Top 5 clientes com maior inadimpl√™ncia
    top_clientes_inadimplentes = df.groupby('cliente')['carteira_inadimplida_arrastada'].sum().nlargest(5)
    insights += "Top 5 Clientes com Maior Inadimpl√™ncia:\n"
    for cliente, valor in top_clientes_inadimplentes.items():
        percentual = (valor / df['carteira_inadimplida_arrastada'].sum()) * 100
        insights += f"- {cliente}: R$ {valor:,.2f} ({percentual:.2f}% da inadimpl√™ncia total)\n"
    
    # An√°lise de Distribui√ß√£o de Opera√ß√µes
    insights += "\nDistribui√ß√£o de Opera√ß√µes:\n"
    operacoes_por_cliente = df.groupby('cliente')['numero_de_operacoes'].agg(['mean', 'sum', 'max'])
    insights += f"M√©dia de Opera√ß√µes por Cliente: {operacoes_por_cliente['mean'].mean():.2f}\n"
    insights += f"Total de Opera√ß√µes: {operacoes_por_cliente['sum'].sum():,.0f}\n"
    
    # An√°lise de Ativos Problem√°ticos
    insights += "\nAtivos Problem√°ticos:\n"
    ativos_por_porte = df.groupby('porte')['ativo_problematico'].agg(['sum', 'mean'])
    for porte, dados in ativos_por_porte.iterrows():
        insights += f"- {porte}: Total R$ {dados['sum']:,.2f}, M√©dia R$ {dados['mean']:,.2f}\n"
    
    # An√°lise de Carteira Ativa vs Inadimplida
    df['percentual_inadimplencia'] = df['carteira_inadimplida_arrastada'] / df['carteira_ativa'] * 100
    percentual_inadimplencia_por_modalidade = df.groupby('modalidade')['percentual_inadimplencia'].mean().sort_values(ascending=False)
    insights += "\nPercentual de Inadimpl√™ncia por Modalidade:\n"
    for modalidade, percentual in percentual_inadimplencia_por_modalidade.head(5).items():
        insights += f"- {modalidade}: {percentual:.2f}%\n"
    
    # An√°lise de Ocupa√ß√µes com Maior Risco
    ocupacoes_risco = df[df['tipo_cliente'] == 'PF'].groupby('ocupacao').agg({
        'carteira_inadimplida_arrastada': 'sum',
        'percentual_inadimplencia': 'mean'
    }).sort_values('carteira_inadimplida_arrastada', ascending=False)
    insights += "\nOcupa√ß√µes de Maior Risco (Pessoa F√≠sica):\n"
    for ocupacao, dados in ocupacoes_risco.head(5).iterrows():
        insights += f"- {ocupacao}: Inadimpl√™ncia R$ {dados['carteira_inadimplida_arrastada']:,.2f}, Percentual {dados['percentual_inadimplencia']:.2f}%\n"
    
    # An√°lise de Sazonalidade
    # More robust date conversion with error handling
    df['ano'] = pd.to_datetime(df['data_base'], format='%d/%m/%Y', errors='coerce').dt.year
    sazonalidade_inadimplencia = df.groupby('ano')['carteira_inadimplida_arrastada'].sum()
    insights += "\nSazonalidade da Inadimpl√™ncia:\n"
    for ano, valor in sazonalidade_inadimplencia.items():
        insights += f"- {ano}: R$ {valor:,.2f}\n"
    
    # Conclus√£o Executiva
    insights += "\nüîç Conclus√£o Executiva:\n"
    insights += "- An√°lise multidimensional revela padr√µes complexos de inadimpl√™ncia\n"
    insights += "- Recomenda-se estratifica√ß√£o de risco por m√∫ltiplos fatores\n"
    insights += "- Monitoramento cont√≠nuo e modelagem preditiva s√£o cruciais\n"
    
    return insights

def main():
    st.title("üí¨ Chatbot Inadimplinha")
    st.caption("üöÄ Chatbot Inadimplinha desenvolvido por Grupo de Inadimpl√™ncia EY")
    
    df = load_data()
    base_insights = generate_base_insights(df)
    if 'messages' not in st.session_state:
        st.session_state.messages = [
            {"role": "system", "content": f"Voc√™ √© um especialista no setor banc√°rio especializado em an√°lise de inadimpl√™ncia no Brasil. Aqui est√£o os dados a serem consultados:\n{base_insights}"},
            {"role": "assistant", "content": "Como posso te ajudar hoje?"}
        ]
    
    for message in st.session_state.messages[1:]:   
        with st.chat_message(message["role"]):
            st.markdown(message["content"])
    
    if prompt := st.chat_input("Fa√ßa uma pergunta sobre a inadimpl√™ncia"):
        client = get_openai_client()
        api_key = client.api_key
        if not api_key:
            st.info("Por favor, adicione sua chave de API para continuar.")
            st.stop()
  
        st.session_state.messages.append({"role": "user", "content": prompt})
        
        with st.chat_message("user"):
            st.markdown(prompt)
         
        with st.chat_message("assistant"):
            message_placeholder = st.empty()
            full_response = ""  
            
            try:
                response = client.chat.completions.create(
                    model="deepseek-chat",
                    messages=st.session_state.messages,
                    stream=True   
                )
        
                for chunk in response:
                    if chunk.choices[0].delta.content is not None:
                        full_response += chunk.choices[0].delta.content
                        message_placeholder.markdown(full_response + "‚ñå")

                message_placeholder.markdown(full_response)

            except Exception as e:
                full_response = f"Erro: {str(e)}"
                message_placeholder.markdown(full_response)
            
            st.session_state.messages.append({"role": "assistant", "content": full_response})
        
    with st.sidebar:
        
        st.sidebar.header("EY Academy | Inadimpl√™ncia")
        st.sidebar.subheader("üîç Sugest√µes de An√°lise")

        st.sidebar.write("Quais s√£o os principais estados com maior inadimpl√™ncia?")
        st.sidebar.write("Qual estado com maior inadimpl√™ncia e quais os valores devidos?")
        st.sidebar.write("Compare a inadimpl√™ncia entre PFe PJ")
        st.sidebar.write("Qual o perfil de inadimpl√™ncia em S√£o Paulo?")
        # st.sidebar.header("EY Academy | Inadimpl√™ncia")
        # st.sidebar.write(f"N√∫mero de registros: {len(df)}")
        # st.sidebar.write("Colunas dispon√≠veis:")
        # st.sidebar.write(df.columns.tolist())

if __name__ == "__main__":
    main()
